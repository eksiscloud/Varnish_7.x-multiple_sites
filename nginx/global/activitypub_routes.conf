# -------------------------------
# ActivityPub ja Fediverse -reitit
# -------------------------------

# 1. Erikoisvastaukset, jotka ei mene backendille

# Mastodonin instanssipolut (esim. /api/v1/instance/, /api/v1/instance/activity)
location ~ ^/api/v1/instance(/.*)?$ {
    access_log off;
    log_not_found off;
    return 404;
}

# Mastodonin oletettu streaming API (esim. /api/v1/streaming/public)
location ~ ^/api/v1/streaming(/.*)?$ {
    access_log off;
    return 204;
}

# Friendican tai muiden vanhojen fediversen endpointien esto
location = /main/salmon {
    access_log off;
    log_not_found off;
    return 404;
}

location ~ ^/nodeinfo/.* {
    access_log off;
    log_not_found off;
    return 404;
}

location = /webfinger {
    access_log off;
    log_not_found off;
    return 404;
}

# Safari/macOS push-unsubscribe (ei tueta, hiljennetään)
location = /api/v1/push/subscription {
    access_log off;
    return 204;
}

# Androidin WebAPK-testi (hiljennetään, ei käytössä)
location = /.well-known/assetlinks.json {
    access_log off;
    return 204;
}

# Googlen liikennekysely (esim. Chrome tai Lighthouse)
location = /.well-known/traffic-advice {
    default_type application/json;
    return 200 '{}';
}

# Friendican Portable Contacts (ei käytössä)
location = /poco {
    access_log off;
    log_not_found off;
    return 404;
}

# Muita turhia API-reittejä joita ei tueta (Friendica/Mastodon)
location ~ ^/api/v1/(directory|timelines|custom_emojis|tags|lists|polls)(/.*)?$ {
    access_log off;
    log_not_found off;
    return 404;
}

# -------------------------------
# Varsinaiset ActivityPub-reitit → backend
# -------------------------------

# Vanha nodeinfo-redirectti Mastodonin väärään oletukseen
location = /nodeinfo/2.0 {
    return 301 https://jagster.eksis.one/wp-json/activitypub/1.0/nodeinfo/2.0;
}

# ActivityPub-reitit (.well-known, webfinger, nodeinfo)
location ^~ /.well-known/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

# WordPressin REST API (tarvitaan mm. ActivityPubille ja muuhun headless-hakuun)
location ^~ /wp-json/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
